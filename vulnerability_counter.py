import requests
import time
from openpyxl import Workbook, load_workbook
from openpyxl.styles import Font, PatternFill, Alignment
from datetime import datetime
import os

def fetch_cves_for_vendor(vendor, asset_type=None, product=None, firmware=None, limit=10):
    """
    Haal CVE's op van de NVD API voor een specifieke vendor/product/type/firmware
    """
    base_url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    
    # Bouw de zoekterm met type, vendor, product en firmware
    search_terms = [vendor]
    if asset_type:
        search_terms.insert(0, asset_type)  # Type eerst voor betere resultaten
    if product:
        search_terms.append(product)
    if firmware:
        search_terms.append(firmware)
    
    # Bouw de query parameters
    params = {
        'keywordSearch': ' '.join(search_terms),
        'resultsPerPage': limit
    }
    
    try:
        search_query = ' '.join(search_terms)
        print(f"  Ophalen CVE's voor '{search_query}'..." + (" " * 30), end='\r')
        response = requests.get(base_url, params=params, timeout=10)
        
        if response.status_code == 200:
            data = response.json()
            vulnerabilities = data.get('vulnerabilities', [])
            
            cve_list = []
            for vuln in vulnerabilities:
                cve_data = vuln.get('cve', {})
                cve_id = cve_data.get('id', 'Unknown')
                descriptions = cve_data.get('descriptions', [])
                description = descriptions[0].get('value', 'No description') if descriptions else 'No description'
                
                # Haal CVSS score op indien beschikbaar
                metrics = cve_data.get('metrics', {})
                cvss_score = 'N/A'
                severity = 'Unknown'
                
                if 'cvssMetricV31' in metrics and metrics['cvssMetricV31']:
                    cvss_data = metrics['cvssMetricV31'][0].get('cvssData', {})
                    cvss_score = cvss_data.get('baseScore', 'N/A')
                    severity = metrics['cvssMetricV31'][0].get('cvssData', {}).get('baseSeverity', 'Unknown')
                elif 'cvssMetricV2' in metrics and metrics['cvssMetricV2']:
                    cvss_data = metrics['cvssMetricV2'][0].get('cvssData', {})
                    cvss_score = cvss_data.get('baseScore', 'N/A')
                    if isinstance(cvss_score, (int, float)):
                        if cvss_score >= 7.0:
                            severity = 'HIGH'
                        elif cvss_score >= 4.0:
                            severity = 'MEDIUM'
                        else:
                            severity = 'LOW'
                
                # Haal published date op
                published = cve_data.get('published', 'Unknown')
                if published != 'Unknown':
                    published = published.split('T')[0]  # Alleen de datum
                
                cve_list.append({
                    'id': cve_id,
                    'description': description[:150] + '...' if len(description) > 150 else description,
                    'cvss_score': cvss_score,
                    'severity': severity,
                    'published': published
                })
            
            return cve_list
        else:
            print(f"  Fout bij ophalen CVE's: Status {response.status_code}")
            return []
    
    except requests.exceptions.RequestException as e:
        print(f"  Netwerkfout: {e}")
        return []
    except Exception as e:
        print(f"  Onverwachte fout: {e}")
        return []

def export_to_excel(assets, asset_vulnerabilities, vulnerability_counts, filename="vulnerability_report.xlsx"):
    """
    Exporteer vulnerability data naar Excel bestand
    """
    print(f"\nExporteren naar Excel: {filename}...")
    
    wb = Workbook()
    
    # Sheet 1: Summary
    ws_summary = wb.active
    ws_summary.title = "Summary"
    
    # Header styling
    header_fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
    header_font = Font(color="FFFFFF", bold=True, size=12)
    
    # Title
    ws_summary['A1'] = "VULNERABILITY ASSESSMENT REPORT"
    ws_summary['A1'].font = Font(bold=True, size=16)
    ws_summary['A2'] = f"Gegenereerd op: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    
    # Summary tabel
    ws_summary['A4'] = "Asset Type"
    ws_summary['B4'] = "Aantal CVE's"
    ws_summary['A4'].fill = header_fill
    ws_summary['B4'].fill = header_fill
    ws_summary['A4'].font = header_font
    ws_summary['B4'].font = header_font
    
    row = 5
    total_cves = 0
    for asset_type, count in sorted(vulnerability_counts.items()):
        ws_summary[f'A{row}'] = asset_type
        ws_summary[f'B{row}'] = count
        total_cves += count
        row += 1
    
    ws_summary[f'A{row}'] = "TOTAAL"
    ws_summary[f'B{row}'] = total_cves
    ws_summary[f'A{row}'].font = Font(bold=True)
    ws_summary[f'B{row}'].font = Font(bold=True)
    
    # Sheet 2: Assets
    ws_assets = wb.create_sheet("Assets")
    
    headers = ['Asset ID', 'Type', 'Brand', 'Model', 'Firmware', 'IP Address', 'Location', 'CVE Count']
    for col, header in enumerate(headers, 1):
        cell = ws_assets.cell(row=1, column=col)
        cell.value = header
        cell.fill = header_fill
        cell.font = header_font
        cell.alignment = Alignment(horizontal='center')
    
    for idx, asset in enumerate(assets, 2):
        cve_count = len(asset_vulnerabilities.get(asset['id'], []))
        ws_assets[f'A{idx}'] = asset['id']
        ws_assets[f'B{idx}'] = asset['type']
        ws_assets[f'C{idx}'] = asset['brand']
        ws_assets[f'D{idx}'] = asset.get('model', 'N/A')
        ws_assets[f'E{idx}'] = asset.get('firmware', 'N/A')
        ws_assets[f'F{idx}'] = asset['ip']
        ws_assets[f'G{idx}'] = asset['location']
        ws_assets[f'H{idx}'] = cve_count
    
    # Sheet 3: Detailed CVEs
    ws_cves = wb.create_sheet("CVE Details")
    
    headers = ['Asset ID', 'Asset Type', 'Brand', 'Firmware', 'CVE ID', 'CVSS Score', 'Severity', 'Published', 'Description']
    for col, header in enumerate(headers, 1):
        cell = ws_cves.cell(row=1, column=col)
        cell.value = header
        cell.fill = header_fill
        cell.font = header_font
    
    row = 2
    for asset in assets:
        cves = asset_vulnerabilities.get(asset['id'], [])
        for cve in cves:
            ws_cves[f'A{row}'] = asset['id']
            ws_cves[f'B{row}'] = asset['type']
            ws_cves[f'C{row}'] = asset['brand']
            ws_cves[f'D{row}'] = asset.get('firmware', 'N/A')
            ws_cves[f'E{row}'] = cve['id']
            ws_cves[f'F{row}'] = cve['cvss_score']
            ws_cves[f'G{row}'] = cve['severity']
            ws_cves[f'H{row}'] = cve['published']
            ws_cves[f'I{row}'] = cve['description']
            
            # Kleurcode op basis van severity
            severity = cve['severity']
            if severity == 'CRITICAL':
                ws_cves[f'G{row}'].fill = PatternFill(start_color="8B0000", end_color="8B0000", fill_type="solid")
                ws_cves[f'G{row}'].font = Font(color="FFFFFF", bold=True)
            elif severity == 'HIGH':
                ws_cves[f'G{row}'].fill = PatternFill(start_color="FF0000", end_color="FF0000", fill_type="solid")
                ws_cves[f'G{row}'].font = Font(color="FFFFFF", bold=True)
            elif severity == 'MEDIUM':
                ws_cves[f'G{row}'].fill = PatternFill(start_color="FFA500", end_color="FFA500", fill_type="solid")
            elif severity == 'LOW':
                ws_cves[f'G{row}'].fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
            
            row += 1
    
    # Kolombreedte aanpassen
    for ws in [ws_summary, ws_assets, ws_cves]:
        for column in ws.columns:
            max_length = 0
            column_letter = column[0].column_letter
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = min(max_length + 2, 50)
            ws.column_dimensions[column_letter].width = adjusted_width
    
    wb.save(filename)
    print(f"✓ Excel bestand opgeslagen: {filename}")

def import_assets_from_excel(filename="assets.xlsx"):
    """
    Importeer assets vanuit Excel bestand
    """
    if not os.path.exists(filename):
        print(f"Bestand {filename} niet gevonden!")
        return None
    
    print(f"\nImporteren van assets uit: {filename}...")
    
    try:
        wb = load_workbook(filename)
        ws = wb.active
        
        assets = []
        
        # Skip header row (row 1)
        for row in ws.iter_rows(min_row=2, values_only=True):
            if row[0]:  # Als er een Asset ID is
                asset = {
                    'id': row[0],
                    'type': row[1].upper() if row[1] else 'UNKNOWN',
                    'brand': row[2] if row[2] else 'Unknown',
                    'model': row[3] if row[3] else '',
                    'firmware': row[4] if row[4] else '',
                    'ip': row[5] if row[5] else 'N/A',
                    'location': row[6] if row[6] else 'Unknown',
                    'status': 'active',
                    'risk_level': 'unknown'
                }
                assets.append(asset)
        
        print(f"✓ {len(assets)} assets geïmporteerd")
        return assets
    
    except Exception as e:
        print(f"Fout bij importeren: {e}")
        return None

def create_asset_template(filename="assets_template.xlsx"):
    """
    Maak een Excel template voor het importeren van assets
    """
    wb = Workbook()
    ws = wb.active
    ws.title = "Assets"
    
    # Header styling
    header_fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
    header_font = Font(color="FFFFFF", bold=True)
    
    headers = ['Asset ID', 'Type', 'Brand', 'Model', 'Firmware', 'IP Address', 'Location']
    for col, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col)
        cell.value = header
        cell.fill = header_fill
        cell.font = header_font
    
    # Voorbeeld data
    example_data = [
        ['PLC-001', 'PLC', 'Siemens', 'S7-1500', 'V2.8', '192.168.1.10', 'Wind Turbine 1'],
        ['PLC-002', 'PLC', 'Rockwell', 'ControlLogix', 'V32.011', '192.168.1.11', 'Wind Turbine 2'],
        ['HMI-001', 'HMI', 'Siemens', 'TP1200', 'V15.1', '192.168.1.50', 'Control Room A']
    ]
    
    for row_idx, data in enumerate(example_data, 2):
        for col_idx, value in enumerate(data, 1):
            ws.cell(row=row_idx, column=col_idx).value = value
    
    # Kolombreedte aanpassen
    for column in ws.columns:
        max_length = 0
        column_letter = column[0].column_letter
        for cell in column:
            try:
                if len(str(cell.value)) > max_length:
                    max_length = len(str(cell.value))
            except:
                pass
        adjusted_width = max_length + 2
        ws.column_dimensions[column_letter].width = adjusted_width
    
    wb.save(filename)
    print(f"✓ Template aangemaakt: {filename}")

def count_vulnerabilities_by_type(assets, export_excel=True):
    """
    Tel aantal CVE's per asset type door externe CVE data op te halen
    """
    print("\n" + "=" * 85)
    print(" " * 25 + "VULNERABILITY COUNTER")
    print("=" * 85 + "\n")
    
    # Dictionary om CVE counts bij te houden per asset type
    vulnerability_counts = {}
    
    # Dictionary om alle CVE's op te slaan per asset
    asset_vulnerabilities = {}
    
    # Verwerk elk asset
    for asset in assets:
        asset_type = asset['type']
        brand = asset['brand']
        asset_id = asset['id']
        model = asset.get('model', '')
        firmware = asset.get('firmware', '')
        
        firmware_display = f" (FW: {firmware})" if firmware else ""
        print(f"\nAsset: {asset_id} ({asset_type} - {brand} {model}{firmware_display})")
        
        # Haal CVE's op voor dit asset - nu met type, brand, model EN firmware
        cves = fetch_cves_for_vendor(brand, asset_type=asset_type, product=model, firmware=firmware, limit=5)
        
        # Update counter
        if asset_type not in vulnerability_counts:
            vulnerability_counts[asset_type] = 0
        
        vulnerability_counts[asset_type] += len(cves)
        asset_vulnerabilities[asset_id] = cves
        
        print(f"  Gevonden: {len(cves)} CVE's")
        
        # Wacht even tussen API calls om rate limiting te voorkomen
        time.sleep(0.6)
    
    # Toon resultaten
    print("\n" + "=" * 85)
    print(" " * 25 + "VULNERABILITY SUMMARY")
    print("=" * 85 + "\n")
    
    print(f"{'Asset Type':<20} {'Aantal CVE\'s':<15}")
    print("-" * 40)
    
    total_cves = 0
    for asset_type, count in sorted(vulnerability_counts.items()):
        print(f"{asset_type:<20} {count:<15}")
        total_cves += count
    
    print("-" * 40)
    print(f"{'TOTAAL':<20} {total_cves:<15}")
    
    # Toon details per asset
    print("\n" + "=" * 85)
    print(" " * 25 + "DETAILED CVE INFORMATION")
    print("=" * 85 + "\n")
    
    for asset_id, cves in asset_vulnerabilities.items():
        if cves:
            asset = next(a for a in assets if a['id'] == asset_id)
            firmware_display = f" - FW: {asset.get('firmware', 'N/A')}" if asset.get('firmware') else ""
            print(f"\n{asset_id} - {asset['brand']} {asset.get('model', '')} ({asset['type']}){firmware_display}:")
            print("-" * 85)
            
            for i, cve in enumerate(cves, 1):
                severity_display = f"[{cve['severity']}]" if cve['severity'] != 'Unknown' else ""
                print(f"  {i}. {cve['id']} - CVSS: {cve['cvss_score']} {severity_display}")
                print(f"     Published: {cve['published']}")
                print(f"     {cve['description']}")
    
    print("\n" + "=" * 85 + "\n")
    
    # Export naar Excel
    if export_excel:
        export_to_excel(assets, asset_vulnerabilities, vulnerability_counts)
    
    return vulnerability_counts

# Voorbeeld assets (gebruik je eigen create_asset functie)
def create_asset(asset_id, asset_type, ip_address, brand, model, firmware, location):
    return {
        'id': asset_id,
        'type': asset_type.upper(),
        'ip': ip_address,
        'brand': brand,
        'model': model,
        'firmware': firmware,
        'location': location,
        'status': 'active',
        'risk_level': 'unknown'
    }

def main():
    print("\n" + "=" * 60)
    print(" " * 15 + "VULNERABILITY ASSESSMENT TOOL")
    print("=" * 60)
    
    print("\n1. Scan assets (handmatig)")
    print("2. Importeer assets uit Excel")
    print("3. Maak Excel template")
    print("4. Afsluiten")
    
    choice = input("\nSelecteer optie (1-4): ").strip()
    
    if choice == '1':
        # Maak test assets aan met firmware versies
        assets = [
            create_asset("PLC-001", "PLC", "192.168.1.10", "Siemens", "S7-1500", "V2.8", "Wind Turbine 1"),
            create_asset("PLC-002", "PLC", "192.168.1.11", "Rockwell", "ControlLogix", "V32.011", "Wind Turbine 2"),
            create_asset("HMI-001", "HMI", "192.168.1.50", "Siemens", "TP1200", "V15.1", "Control Room A"),
            create_asset("RTU-001", "RTU", "192.168.1.60", "Schneider", "SCADAPack", "7.12", "Substation 1"),
        ]
        
        # Tel vulnerabilities en exporteer
        vuln_counts = count_vulnerabilities_by_type(assets, export_excel=True)
        
    elif choice == '2':
        # Importeer assets uit Excel
        assets = import_assets_from_excel("assets.xlsx")
        if assets:
            vuln_counts = count_vulnerabilities_by_type(assets, export_excel=True)
        else:
            print("Geen assets geïmporteerd. Maak eerst een assets.xlsx bestand.")
            
    elif choice == '3':
        # Maak template
        create_asset_template()
        print("\nVul de template in met je assets en sla op als 'assets.xlsx'")
        print("Gebruik dan optie 2 om de assets te importeren en scannen.")
        
    elif choice == '4':
        print("\nTot ziens!")
    else:
        print("\nOngeldige keuze.")

if __name__ == "__main__":
    main()
