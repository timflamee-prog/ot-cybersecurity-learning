import requests
import time

def fetch_cves_for_vendor(vendor, product=None, limit=10):
    """
    Haal CVE's op van de NVD API voor een specifieke vendor/product
    """
    base_url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    
    # Bouw de query parameters
    params = {
        'keywordSearch': f"{vendor}",
        'resultsPerPage': limit
    }
    
    if product:
        params['keywordSearch'] = f"{vendor} {product}"
    
    try:
        print(f"  Ophalen CVE's voor {vendor}..." + (" " * 20), end='\r')
        response = requests.get(base_url, params=params, timeout=10)
        
        if response.status_code == 200:
            data = response.json()
            vulnerabilities = data.get('vulnerabilities', [])
            
            cve_list = []
            for vuln in vulnerabilities:
                cve_data = vuln.get('cve', {})
                cve_id = cve_data.get('id', 'Unknown')
                descriptions = cve_data.get('descriptions', [])
                description = descriptions[0].get('value', 'No description') if descriptions else 'No description'
                
                # Haal CVSS score op indien beschikbaar
                metrics = cve_data.get('metrics', {})
                cvss_score = 'N/A'
                if 'cvssMetricV31' in metrics and metrics['cvssMetricV31']:
                    cvss_score = metrics['cvssMetricV31'][0].get('cvssData', {}).get('baseScore', 'N/A')
                elif 'cvssMetricV2' in metrics and metrics['cvssMetricV2']:
                    cvss_score = metrics['cvssMetricV2'][0].get('cvssData', {}).get('baseScore', 'N/A')
                
                cve_list.append({
                    'id': cve_id,
                    'description': description[:100] + '...' if len(description) > 100 else description,
                    'cvss_score': cvss_score
                })
            
            return cve_list
        else:
            print(f"  Fout bij ophalen CVE's: Status {response.status_code}")
            return []
    
    except requests.exceptions.RequestException as e:
        print(f"  Netwerkfout: {e}")
        return []
    except Exception as e:
        print(f"  Onverwachte fout: {e}")
        return []

def count_vulnerabilities_by_type(assets):
    """
    Tel aantal CVE's per asset type door externe CVE data op te halen
    """
    print("\n" + "=" * 85)
    print(" " * 25 + "VULNERABILITY COUNTER")
    print("=" * 85 + "\n")
    
    # Dictionary om CVE counts bij te houden per asset type
    vulnerability_counts = {}
    
    # Dictionary om alle CVE's op te slaan per asset
    asset_vulnerabilities = {}
    
    # Verwerk elk asset
    for asset in assets:
        asset_type = asset['type']
        brand = asset['brand']
        asset_id = asset['id']
        
        print(f"\nAsset: {asset_id} ({asset_type} - {brand})")
        
        # Haal CVE's op voor dit asset
        cves = fetch_cves_for_vendor(brand, limit=5)
        
        # Update counter
        if asset_type not in vulnerability_counts:
            vulnerability_counts[asset_type] = 0
        
        vulnerability_counts[asset_type] += len(cves)
        asset_vulnerabilities[asset_id] = cves
        
        print(f"  Gevonden: {len(cves)} CVE's")
        
        # Wacht even tussen API calls om rate limiting te voorkomen
        time.sleep(0.6)
    
    # Toon resultaten
    print("\n" + "=" * 85)
    print(" " * 25 + "VULNERABILITY SUMMARY")
    print("=" * 85 + "\n")
    
    print(f"{'Asset Type':<20} {'Aantal CVE\'s':<15}")
    print("-" * 40)
    
    total_cves = 0
    for asset_type, count in sorted(vulnerability_counts.items()):
        print(f"{asset_type:<20} {count:<15}")
        total_cves += count
    
    print("-" * 40)
    print(f"{'TOTAAL':<20} {total_cves:<15}")
    
    # Toon details per asset
    print("\n" + "=" * 85)
    print(" " * 25 + "DETAILED CVE INFORMATION")
    print("=" * 85 + "\n")
    
    for asset_id, cves in asset_vulnerabilities.items():
        if cves:
            asset = next(a for a in assets if a['id'] == asset_id)
            print(f"\n{asset_id} - {asset['brand']} ({asset['type']}):")
            print("-" * 85)
            
            for i, cve in enumerate(cves, 1):
                print(f"  {i}. {cve['id']} - CVSS: {cve['cvss_score']}")
                print(f"     {cve['description']}")
    
    print("\n" + "=" * 85 + "\n")
    
    return vulnerability_counts

# Voorbeeld assets (gebruik je eigen create_asset functie)
def create_asset(asset_id, asset_type, ip_address, brand, model, location):
    return {
        'id': asset_id,
        'type': asset_type.upper(),
        'ip': ip_address,
        'brand': brand,
        'model': model,
        'location': location,
        'status': 'active',
        'risk_level': 'unknown'
    }

def main():
    # Maak test assets aan
    assets = [
        create_asset("PLC-001", "PLC", "192.168.1.10", "Siemens", "S7-1500", "Wind Turbine 1"),
        create_asset("PLC-002", "PLC", "192.168.1.11", "Rockwell", "MicroLogix", "Wind Turbine 2"),
        create_asset("HMI-001", "HMI", "192.168.1.50", "Siemens", "TP", "Control Room A"),
        create_asset("RTU-001", "RTU", "192.168.1.60", "Schneider", "SCADAPack", "Substation 1"),
    ]
    
    # Tel vulnerabilities
    vuln_counts = count_vulnerabilities_by_type(assets)
    
    print("\nVulnerability counts dictionary:")
    print(vuln_counts)

if __name__ == "__main__":
    main()